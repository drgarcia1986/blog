<!DOCTYPE html>
<html lang="pt">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="">


        <title>A armadilha dos argumentos com valores padrão</title>

            <link href="http://www.diego-garcia.info/atom.xml" type="application/atom+xml" rel="alternate" title="Diego Garcia Full Atom Feed" />
            <link href="http://www.diego-garcia.info/python.atom.xml" type="application/atom+xml" rel="alternate" title="Diego Garcia Categories Atom Feed" />

        <!-- Bootstrap Core CSS -->
        <link href="http://www.diego-garcia.info/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="http://www.diego-garcia.info/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="http://www.diego-garcia.info/theme/css/code_blocks/monokai.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->




        <meta name="tags" contents="python" />
        <meta name="tags" contents="anti-pattern" />


	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="Diego Garcia">

	<meta property="og:type" content="article">
	<meta property="article:author" content="">
	<meta property="og:url" content="http://www.diego-garcia.info/2015/06/07/a-armadilha-dos-argumentos-com-valores-default/">
	<meta property="og:title" content="A armadilha dos argumentos com valores padrão">
	<meta property="og:description" content="">
	<meta property="og:image" content="http://www.diego-garcia.info/">
	<meta property="article:published_time" content="2015-06-07 11:00:00-03:00">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://www.diego-garcia.info/">Diego Garcia</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-color: black">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>A armadilha dos argumentos com valores padrão</h1>
                        <span class="meta">Posted by
                                <a href="http://www.diego-garcia.info/author/diego-garcia.html">Diego Garcia</a>
                             on Sun 07 June 2015
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <p>Algo muito comum em várias linguagens de programação é a possibilidade de definir <em>valores default</em> (valores padrão) para argumentos de funções e métodos, tornando a utilização desses opcional.
Isso é ótimo, principalmente para manter retrocompatibilidade, porém, o python possui uma pequena armadilha que caso passe despercebida, pode causar sérios problemas, muitas vezes difíceis de serem detectados.
Essa armadilha ocorre quando usamos valores de tipos <code>mutáveis</code> como valor default de argumentos.</p>


<h3>O que são tipos mutáveis e imutáveis?</h3>
<p>Segundo a <a href="https://docs.python.org/3.4/reference/datamodel.html">documentação oficial do python</a>, o valor de alguns objetos pode mudar, esses objetos que podem ter seu valor alterado após serem criados são chamados de mutáveis, enquanto que os objetos que não podem ter seus valores alterados após serem criados são chamados de imutáveis (simples assim).</p>
<ul>
<li><strong>Tipos mutáveis</strong>:</li>
</ul>
<p>Listas, Dicionários e tipos definidos pelo usuário.</p>
<ul>
<li><strong>Tipos imutáveis</strong>:</li>
</ul>
<p>Numeros, Strings e Tuplas.</p>
<blockquote>
<p>Apesar de serem imutáveis, a utilização de um valor mutável (uma lista por exemplo) dentro de uma tupla, pode causar o efeito <em><a href="http://pythonclub.com.br/tuplas-mutantes-em-python.html">tuplas mutáveis</a></em>, onde visualmente o valor da tupla é alterado, mas por trás dos panos o valor da tupla não muda, o que muda é o valor do objeto pelo qual a tupla está se referenciando.</p>
</blockquote>
<h3>A armadilha</h3>
<p>Como disse no começo desse blogpost, é muito comum a utilização de valores default em agurmentos de funções e métodos, por essa razão, nos sentimos seguros em fazer algo desse tipo:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_function</span><span class="p">(</span><span class="n">my_list</span><span class="o">=</span><span class="p">[]):</span>
    <span class="n">my_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">my_list</span><span class="p">)</span>
</pre></div>


<p>Porém, levando esse exemplo em consideração, o que irá acontecer se invocarmos essa função 3 vezes?</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">my_function</span><span class="p">()</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">my_function</span><span class="p">()</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">my_function</span><span class="p">()</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>


<p>Sim, o valor do argumento <code>my_list</code> mudou em cada vez que executamos a função sem passar algum valor para ele.</p>
<h3>Por que isso acontece?</h3>
<p>Isso acontece porque o python processa os valores default de cada argumentos de uma função (ou método) quando essa for definida, após esse processamento o valor é atribuido ao objeto da função.
Ou seja, por questões de optimização, seguindo nosso exemplo, o python não cria uma lista vazia para o argumento <code>my_list</code> a cada vez que a função <code>my_function</code> for invocada, ele reaproveita uma lista que foi criada no momento em que essa função foi importada.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">my_function</span><span class="o">.</span><span class="n">func_defaults</span>
<span class="p">([],)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">id</span><span class="p">(</span><span class="n">my_function</span><span class="o">.</span><span class="n">func_defaults</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="mi">140634243738080</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">my_function</span><span class="p">()</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">my_function</span><span class="o">.</span><span class="n">func_defaults</span>
<span class="p">([</span><span class="mi">1</span><span class="p">],)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">id</span><span class="p">(</span><span class="n">my_function</span><span class="o">.</span><span class="n">func_defaults</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="mi">140634243738080</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">my_function</span><span class="p">()</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">my_function</span><span class="o">.</span><span class="n">func_defaults</span>
<span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">id</span><span class="p">(</span><span class="n">my_function</span><span class="o">.</span><span class="n">func_defaults</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="mi">140634243738080</span>
</pre></div>


<blockquote>
<p>Note que a identificação do argumento (no caso <code>my_list</code>) não muda, mesmo executando a função várias vezes.</p>
</blockquote>
<p>Outro exemplo seria utilizar o resultado de funções como valores default de argumentos, por exemplo, uma função com um argumento que recebe como default o valor de <code>datetime.now()</code>.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">what_time_is_it</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M:%S&#39;</span><span class="p">))</span>
</pre></div>


<p>O valor do argumento <code>dt</code> sempre será o <em>datetime</em> do momento em que o python carregou a função e não o <em>datetime</em> de quando a função foi invocada.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">what_time_is_it</span><span class="p">()</span>
<span class="mo">07</span><span class="o">/</span><span class="mo">06</span><span class="o">/</span><span class="mi">2015</span> <span class="mi">08</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">55</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">what_time_is_it</span><span class="p">()</span>
<span class="mo">07</span><span class="o">/</span><span class="mo">06</span><span class="o">/</span><span class="mi">2015</span> <span class="mi">08</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">55</span>
</pre></div>


<h3>Isso também acontece com classes?</h3>
<p>Sim e de uma forma ainda mais perigosa.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ListNumbers</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numbers</span><span class="o">=</span><span class="p">[]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numbers</span> <span class="o">=</span> <span class="n">numbers</span>

    <span class="k">def</span> <span class="nf">add_number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_numbers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
</pre></div>


<p>Assim como no caso das funções, no exemplo acima o argumento <code>numbers</code> é definido no momento em que o python importa a classe, ou seja, a cada nova instância da classe <code>ListNumbers</code>, será aproveitada a mesma lista no argumento <code>numbers</code>.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">list1</span> <span class="o">=</span> <span class="n">ListNumbers</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">list2</span> <span class="o">=</span> <span class="n">ListNumbers</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">list1</span><span class="o">.</span><span class="n">show_numbers</span><span class="p">()</span>
<span class="p">[]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">list2</span><span class="o">.</span><span class="n">show_numbers</span><span class="p">()</span>
<span class="p">[]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">list2</span><span class="o">.</span><span class="n">add_number</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">list1</span><span class="o">.</span><span class="n">show_numbers</span><span class="p">()</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">list2</span><span class="o">.</span><span class="n">show_numbers</span><span class="p">()</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">list1</span><span class="o">.</span><span class="n">numbers</span> <span class="ow">is</span> <span class="n">list2</span><span class="o">.</span><span class="n">numbers</span>
<span class="bp">True</span>
</pre></div>


<h3>Por que isso não acontece com Strings?</h3>
<p>Porque strings são <code>imutáveis</code>, o que significa que a cada alteração de valor em uma variavel que armazena uma strings, o python cria uma nova instância para essa variável.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">id</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="mi">140398402003832</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">id</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="mi">140398402003872</span>  <span class="c1"># o penúltimo número muda :)</span>
</pre></div>


<p>Em argumentos com valores default, não é diferente.</p>
<div class="highlight"><pre><span></span>def my_function(my_str=&#39;abc&#39;):
    my_str += &#39;d&#39;
    print(my_str)
</pre></div>


<p>No exemplo acima, sempre que for executado o <code>inplace add</code> (<code>+=</code>) será criada outra váriavel para <code>my_str</code> sem alterar o valor default do argumento.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">my_function</span><span class="p">()</span>
<span class="n">abcd</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">my_function</span><span class="o">.</span><span class="n">func_defaults</span>
<span class="p">(</span><span class="s1">&#39;abc&#39;</span><span class="p">,)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">my_function</span><span class="p">()</span>
<span class="n">abcd</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">my_function</span><span class="o">.</span><span class="n">func_defaults</span>
<span class="p">(</span><span class="s1">&#39;abc&#39;</span><span class="p">,)</span>
</pre></div>


<h3>Como se proteger?</h3>
<p>A maneira mais simples de evitar esse tipo de surpresa é utilizar um <a href="http://en.wikipedia.org/wiki/Sentinel_value">valor sentinela</a> como por exemplo <code>None</code>, nos argumentos opcionais que esperam tipos mutáveis:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_function</span><span class="p">(</span><span class="n">my_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">my_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">my_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">my_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">my_list</span><span class="p">)</span>
</pre></div>


<p>Ou, para deixar o código ainda mais elegante, podemos simplificar a condicional com um simples <code>or</code>:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_function</span><span class="p">(</span><span class="n">my_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">my_list</span> <span class="o">=</span> <span class="n">my_list</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">my_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">my_list</span><span class="p">)</span>
</pre></div>


<blockquote>
<p>Obrigado <a href="http://pythonclub.com.br/author/bruno-cezar-rocha.html">Bruno Rocha</a> pela sugestão.</p>
</blockquote>
<p>Pronto, sem surpresas e sem armadilhas :).</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">my_function</span><span class="p">()</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">my_function</span><span class="p">()</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">my_function</span><span class="p">()</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>


<h3>Referências</h3>
<ul>
<li><a href="http://shop.oreilly.com/product/0636920032519.do">Fluent Python (Mutable types as parameter defaults: bad idea)</a></li>
<li><a href="http://docs.quantifiedcode.com/python-anti-patterns/correctness/mutable_default_value_as_argument.html">Python Anti-Patterns (Using a mutable default value as an argument)</a></li>
</ul>
    </article>

        <div class="tags">
            <p>tags: <a href="http://www.diego-garcia.info/tag/python.html">python</a>, <a href="http://www.diego-garcia.info/tag/anti-pattern.html">anti-pattern</a>, </p>
        </div>

<hr>
<div class="sharing">
</div>
    <hr>

        <div class="comments">
            <h2>Comments !</h2>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'codeforcloud';
                var disqus_identifier = '2015/06/07/a-armadilha-dos-argumentos-com-valores-default/';
                var disqus_url = 'http://www.diego-garcia.info/2015/06/07/a-armadilha-dos-argumentos-com-valores-default/';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//codeforcloud.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="https://twitter.com/drgarcia1986">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/drgarcia1986">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://www.linkedin.com/in/drgarcia1986">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<p class="copyright text-muted">
    Blog powered by <a href="http://getpelican.com">Pelican</a>,
    which takes great advantage of <a href="http://python.org">Python</a>.
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="http://www.diego-garcia.info/theme/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="http://www.diego-garcia.info/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="http://www.diego-garcia.info/theme/js/clean-blog.min.js"></script>

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-56972446-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'codeforcloud';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>

</html>